# Generated by Django 3.2.4 on 2021-06-07 12:27
import os

import google.auth
from django.conf import settings
from django.contrib.auth.models import User
from django.db import migrations, models
import django.db.models.deletion
from django.db.backends.postgresql.schema import DatabaseSchemaEditor
from django.db.migrations.state import StateApps
from google.cloud import secretmanager


def createsuperuser(apps: StateApps, schema_editor: DatabaseSchemaEditor) -> None:
    """
    Dynamically create an admin user as part of a migration
    Password is pulled from Secret Manger (previously created as part of tutorial)
    """
    if os.getenv("TRAMPOLINE_CI", None):
        # We are in CI, so just create a placeholder user for unit testing.
        admin_password = "test"
    else:
        client = secretmanager.SecretManagerServiceClient()

        # Get project value for identifying current context
        _, project = google.auth.default()

        # Retrieve the previously stored admin password
        PASSWORD_NAME = os.environ.get("PASSWORD_NAME", "superuser_password")
        name = f"projects/{project}/secrets/{PASSWORD_NAME}/versions/latest"
        admin_password = client.access_secret_version(name=name).payload.data.decode(
            "UTF-8"
        )

    # Create a new user using acquired password, stripping any accidentally stored newline characters
    User.objects.create_superuser("admin", password=admin_password.strip())


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Challenge',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('created_date_time', models.DateTimeField(auto_created=True, auto_now_add=True)),
                ('name', models.CharField(max_length=50)),
                ('description', models.TextField(blank=True)),
                ('solver_script_path', models.CharField(default='', max_length=255)),
                ('assignment_modal_template_path', models.CharField(default='', max_length=255)),
                ('image_src_path', models.CharField(default='', max_length=255)),
                ('is_published', models.BooleanField(default=False)),
                ('is_timed', models.BooleanField(default=True)),
                ('max_score', models.FloatField()),
                ('number_of_attempts', models.IntegerField(default=-1)),
                ('time_limit_in_minutes', models.IntegerField(default=10)),
                ('slug', models.SlugField()),
                ('generator_script_path', models.CharField(default='', max_length=255)),
                ('scoreboard_field', models.CharField(choices=[('t', 'Duration'), ('s', 'Score')], default='s', max_length=1)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
            ],
        ),
        migrations.CreateModel(
            name='ChallengeAttempt',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('attempted_by', models.CharField(max_length=32)),
                ('attempted_date_time', models.DateTimeField(editable=False)),
                ('score', models.FloatField()),
                ('duration', models.DurationField(blank=True, null=True)),
                ('completed', models.BooleanField(default=False)),
                ('challenge', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='attempts', to='home.challenge')),
            ],
        ),
        migrations.RunPython(createsuperuser),
    ]
